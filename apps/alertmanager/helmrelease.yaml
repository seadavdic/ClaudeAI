apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: alertmanager
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: alertmanager
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  targetNamespace: alertmanager
  install:
    createNamespace: true
  values:
    # AlertManager configuration
    config:
      global:
        resolve_timeout: 5m

      # Route defines how alerts are grouped and sent to receivers
      route:
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 10s
        group_interval: 10s
        repeat_interval: 12h
        receiver: 'default'
        routes:
          # Critical alerts go to critical receiver
          - match:
              severity: critical
            receiver: critical
            continue: true

          # Batch job alerts
          - match:
              alertname: BatchJobFailureRate
            receiver: batch-job-alerts

          # Node/hardware alerts
          - match_re:
              alertname: ^(NodeDown|HighCPUUsage|HighMemoryUsage|HighTemperature)$
            receiver: infrastructure-alerts

      # Receivers define where to send alerts
      receivers:
        - name: 'default'
          webhook_configs:
            - url: 'http://alert-webhook.alertmanager.svc.cluster.local:5001/webhook'
              send_resolved: true
          # Uncomment and configure for email notifications
          # email_configs:
          #   - to: 'your-email@example.com'
          #     from: 'alertmanager@your-cluster.local'
          #     smarthost: 'smtp.gmail.com:587'
          #     auth_username: 'your-email@example.com'
          #     auth_password: 'your-app-password'
          #     headers:
          #       Subject: '[ALERT] {{ .GroupLabels.alertname }}'

        - name: 'critical'
          webhook_configs:
            - url: 'http://alert-webhook.alertmanager.svc.cluster.local:5001/webhook/critical'
              send_resolved: true

        - name: 'batch-job-alerts'
          webhook_configs:
            - url: 'http://alert-webhook.alertmanager.svc.cluster.local:5001/webhook/batch-jobs'
              send_resolved: true

        - name: 'infrastructure-alerts'
          webhook_configs:
            - url: 'http://alert-webhook.alertmanager.svc.cluster.local:5001/webhook/infrastructure'
              send_resolved: true

      # Inhibition rules suppress certain alerts when others are firing
      inhibit_rules:
        - source_match:
            severity: 'critical'
          target_match:
            severity: 'warning'
          equal: ['alertname', 'cluster', 'service']

    # Persistence for alert state
    persistence:
      enabled: true
      storageClass: local-path
      size: 2Gi

    # Service configuration
    service:
      type: ClusterIP
      port: 9093

    # Resources
    resources:
      requests:
        memory: 64Mi
        cpu: 50m
      limits:
        memory: 128Mi
        cpu: 100m

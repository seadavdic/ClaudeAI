apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: prometheus
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: prometheus
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
  targetNamespace: prometheus
  install:
    createNamespace: true
  values:
    server:
      persistentVolume:
        enabled: true
        size: 5Gi
        storageClass: local-path
      retention: "2d"
      service:
        type: ClusterIP
        servicePort: 80
    alertmanager:
      enabled: false  # Using separate AlertManager deployment
    pushgateway:
      enabled: false
    nodeExporter:
      enabled: true
    kubeStateMetrics:
      enabled: true
    serverFiles:
      prometheus.yml:
        scrape_configs:
          - job_name: 'metrics-app'
            static_configs:
              - targets: ['metrics-app.metrics-app.svc.cluster.local:8000']
            scrape_interval: 30s
            metrics_path: '/metrics'

          - job_name: 'smartbiz-api'
            static_configs:
              - targets: ['smartbiz-api.smartbiz.svc.cluster.local:8000']
            scrape_interval: 30s
            metrics_path: '/metrics'

          - job_name: 'rabbitmq'
            static_configs:
              - targets: ['rabbitmq.rabbitmq.svc.cluster.local:15692']
            scrape_interval: 30s
            metrics_path: '/metrics'

          - job_name: 'order-generator'
            static_configs:
              - targets: ['order-generator.order-pipeline.svc.cluster.local:8000']
            scrape_interval: 30s
            metrics_path: '/metrics'

          - job_name: 'payment-service'
            static_configs:
              - targets: ['payment-service.order-pipeline.svc.cluster.local:8001']
            scrape_interval: 30s
            metrics_path: '/metrics'

          - job_name: 'fulfillment-service'
            static_configs:
              - targets: ['fulfillment-service.order-pipeline.svc.cluster.local:8002']
            scrape_interval: 30s
            metrics_path: '/metrics'

          - job_name: 'notification-service'
            static_configs:
              - targets: ['notification-service.order-pipeline.svc.cluster.local:8003']
            scrape_interval: 30s
            metrics_path: '/metrics'

      # Alert rules
      alerting_rules.yml:
        groups:
          # Application Metrics Alerts
          - name: application_metrics
            interval: 30s
            rules:
              - alert: HighErrorRate
                expr: |
                  sum(rate(http_errors_total[5m])) > 10
                for: 2m
                labels:
                  severity: warning
                  component: metrics-app
                annotations:
                  summary: "High error rate detected"
                  description: "Error rate is {{ $value }} errors/sec (threshold: 10/sec)"

              - alert: HighRequestRate
                expr: |
                  sum(rate(http_requests_total[5m])) > 100
                for: 5m
                labels:
                  severity: info
                  component: metrics-app
                annotations:
                  summary: "High request rate"
                  description: "Request rate is {{ $value }} requests/sec"

              - alert: SlowResponseTime
                expr: |
                  histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 2
                for: 5m
                labels:
                  severity: warning
                  component: metrics-app
                annotations:
                  summary: "Slow response time (p95)"
                  description: "95th percentile response time is {{ $value }}s (threshold: 2s)"

          # Node/Infrastructure Alerts
          - name: infrastructure
            interval: 30s
            rules:
              - alert: HighCPUUsage
                expr: |
                  100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
                for: 5m
                labels:
                  severity: warning
                  component: infrastructure
                annotations:
                  summary: "High CPU usage on {{ $labels.instance }}"
                  description: "CPU usage is {{ $value }}% (threshold: 80%)"

              - alert: HighMemoryUsage
                expr: |
                  (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
                for: 5m
                labels:
                  severity: warning
                  component: infrastructure
                annotations:
                  summary: "High memory usage on {{ $labels.instance }}"
                  description: "Memory usage is {{ $value }}% (threshold: 85%)"

              - alert: HighTemperature
                expr: |
                  node_hwmon_temp_celsius > 75
                for: 5m
                labels:
                  severity: warning
                  component: infrastructure
                annotations:
                  summary: "High temperature on {{ $labels.instance }}"
                  description: "Temperature is {{ $value }}°C (threshold: 75°C)"

              - alert: NodeDown
                expr: |
                  up{service=~".*node-exporter.*"} == 0
                for: 1m
                labels:
                  severity: critical
                  component: infrastructure
                annotations:
                  summary: "Node {{ $labels.node }} is down"
                  description: "Node exporter is not reachable on {{ $labels.node }}"

              - alert: DiskSpaceRunningLow
                expr: |
                  (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
                for: 5m
                labels:
                  severity: warning
                  component: infrastructure
                annotations:
                  summary: "Disk space running low on {{ $labels.instance }}"
                  description: "Only {{ $value }}% disk space remaining (threshold: 15%)"

    # Configure Prometheus to send alerts to AlertManager
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
                - alertmanager.alertmanager.svc.cluster.local:9093
